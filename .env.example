# AI Chatbot Configuration
# Copy this file to .env and fill in your values

# =============================================================================
# Gemini API
# =============================================================================
# Get your API key from: https://aistudio.google.com/apikey
GEMINI_API_KEY=your-gemini-api-key-here

# Maximum prompt length for image generation (default: 2000 characters)
MAX_IMAGE_PROMPT_LENGTH=2000

# =============================================================================
# Google Identity Services (for production)
# =============================================================================
# Create credentials at: https://console.cloud.google.com/apis/credentials
# Create an OAuth 2.0 Client ID (Web application type)
# Add http://localhost:8000 to "Authorized JavaScript origins"
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com

# Timeout for Google token verification requests in seconds (default: 10)
GOOGLE_AUTH_TIMEOUT=10

# =============================================================================
# Authentication
# =============================================================================
# Generate a secure secret: python -c "import secrets; print(secrets.token_hex(32))"
JWT_SECRET_KEY=change-this-to-a-secure-random-string

# Comma-separated list of allowed email addresses
ALLOWED_EMAILS=you@gmail.com,friend@gmail.com

# =============================================================================
# Server Configuration
# =============================================================================
# Port to run the server on
PORT=8000

# Flask environment: "development" skips auth, "production" requires Google Sign In
FLASK_ENV=development

# Application URL (used for generating clickable links in notifications, e.g., WhatsApp)
# Set this to your public-facing URL in production
# Example: https://chat.example.com
APP_URL=

# =============================================================================
# Gunicorn Settings
# =============================================================================
# Number of worker processes (default: 2)
# Recommended: 2-4 x number of CPU cores
GUNICORN_WORKERS=2

# Worker timeout in seconds (default: 300 = 5 minutes)
# Increase for long-running operations like image generation
# IMPORTANT: If using a reverse proxy (nginx), ensure its timeouts match or exceed this value
GUNICORN_TIMEOUT=300

# Worker recycling: restart workers after N requests to bound memory growth (default: 1000)
# Jitter prevents all workers from restarting simultaneously
# Usage in systemd ExecStart: --max-requests $GUNICORN_MAX_REQUESTS --max-requests-jitter $GUNICORN_MAX_REQUESTS_JITTER
GUNICORN_MAX_REQUESTS=1000
GUNICORN_MAX_REQUESTS_JITTER=50

# SSE keepalive interval in seconds (default: 15)
# Sends heartbeat comments during LLM "thinking" phase to prevent proxy timeouts
# Should be less than nginx proxy_read_timeout
SSE_KEEPALIVE_INTERVAL=15

# =============================================================================
# Request Timeouts
# =============================================================================
# Chat request timeout in seconds (default: 300 = 5 minutes)
# Generous default to accommodate image generation and complex tool chains
CHAT_TIMEOUT=300

# Tool execution timeout in seconds (default: 90)
# Timeout for individual tool calls (web search, URL fetch, image generation)
TOOL_TIMEOUT=90

# =============================================================================
# Streaming Cleanup
# =============================================================================
# Timeout for cleanup thread waiting for stream thread to complete (default: 600 = 10 minutes)
# If stream thread doesn't complete within this time, cleanup thread gives up
STREAM_CLEANUP_THREAD_TIMEOUT=600

# Delay in seconds before checking if message was saved (default: 1.0)
# Allows generator to process final tuple if client still connected
STREAM_CLEANUP_WAIT_DELAY=1.0

# =============================================================================
# Database
# =============================================================================
# SQLite database file path (relative to project root)
DATABASE_PATH=chatbot.db

# LangGraph checkpoint database path (default: data/checkpoints.db)
# Each gunicorn worker opens its own connection; WAL mode enables concurrent access
CHECKPOINT_DB_PATH=data/checkpoints.db

# Slow query threshold in milliseconds (default: 100)
# Only active in development/debug mode
SLOW_QUERY_THRESHOLD_MS=100

# =============================================================================
# File Upload Settings
# =============================================================================
# Maximum file size in bytes (default: 20971520 = 20 MB)
MAX_FILE_SIZE=20971520

# Maximum number of files per message (default: 10)
MAX_FILES_PER_MESSAGE=10

# Comma-separated list of allowed MIME types
ALLOWED_FILE_TYPES=image/png,image/jpeg,image/gif,image/webp,application/pdf,text/plain,text/markdown,application/json,text/csv

# Maximum thumbnail width in pixels (default: 400)
THUMBNAIL_MAX_WIDTH=400

# Maximum thumbnail height in pixels (default: 400)
THUMBNAIL_MAX_HEIGHT=400

# JPEG quality for thumbnails (1-100, default: 85)
THUMBNAIL_QUALITY=85

# =============================================================================
# Logging
# =============================================================================
# Log level: DEBUG, INFO, WARNING, ERROR, CRITICAL (default: INFO)
# Use DEBUG for detailed troubleshooting, INFO for normal operation
LOG_LEVEL=INFO

# =============================================================================
# User Context
# =============================================================================
# User's location for contextual responses
# The LLM uses this to provide appropriate:
# - Measurement units (metric vs imperial)
# - Currency preferences
# - Local retailer/service recommendations
# - Regional availability of products
# - Date/time formats
# Format: "City, Country" (e.g., "Prague, Czech Republic" or "New York, USA")
# Leave empty to disable location-based context
USER_LOCATION=

# =============================================================================
# Cost Tracking
# =============================================================================
# Display currency for cost tracking (USD, CZK, EUR, GBP)
# Default: CZK
COST_CURRENCY=CZK

# Maximum number of months for cost history (default: 120 = 10 years)
COST_HISTORY_MAX_MONTHS=120

# Default number of months for cost history queries (default: 12)
COST_HISTORY_DEFAULT_LIMIT=12

# =============================================================================
# Todoist Integration
# =============================================================================
# Register your app at: https://developer.todoist.com/appconsole.html
# Create an OAuth app and get your Client ID and Secret
# Set the redirect URI to: http://localhost:5173/auth/todoist/callback (dev with Vite)
# or https://yourdomain.com/auth/todoist/callback (production)
TODOIST_CLIENT_ID=
TODOIST_CLIENT_SECRET=
TODOIST_REDIRECT_URI=http://localhost:5173/auth/todoist/callback

# Timeout for Todoist API requests in seconds (default: 10)
TODOIST_API_TIMEOUT=10

# =============================================================================
# Google Calendar Integration
# =============================================================================
# Create OAuth credentials at https://console.cloud.google.com/apis/credentials
# Enable the Google Calendar API and configure the same redirect URI used by the frontend (Vite dev server is http://localhost:5173)
GOOGLE_CALENDAR_CLIENT_ID=
GOOGLE_CALENDAR_CLIENT_SECRET=
GOOGLE_CALENDAR_REDIRECT_URI=http://localhost:5173

# Timeout for Google Calendar API requests in seconds (default: 10)
GOOGLE_CALENDAR_API_TIMEOUT=10

# =============================================================================
# Garmin Connect Integration
# =============================================================================
# No API keys needed — uses garminconnect library with garth session tokens.
# Users authenticate with email/password in settings; only session tokens are stored.

# Timeout for Garmin API requests in seconds (default: 15)
GARMIN_API_TIMEOUT=15

# =============================================================================
# Weather Integration (Yr.no)
# =============================================================================
# Location for weather forecasts in planner dashboard
# Format: "latitude,longitude" (e.g., "50.0755,14.4378" for Prague)
# Get coordinates from: https://www.latlong.net/
# Leave empty to disable weather in planner
WEATHER_LOCATION=

# Weather cache TTL in seconds (default: 21600 = 6 hours)
# Weather forecasts don't change frequently, so longer cache is fine
WEATHER_CACHE_TTL_SECONDS=21600

# Timeout for Yr.no API requests in seconds (default: 10)
WEATHER_API_TIMEOUT=10

# Application version and contact email (required by Yr.no in User-Agent header)
APP_VERSION=1.0.0
CONTACT_EMAIL=admin@example.com

# =============================================================================
# Code Sandbox (Docker)
# =============================================================================
# Enable code execution in a secure Docker sandbox (default: true)
# Requires custom Docker image with pre-installed fonts and libraries
# Build with: make sandbox-image
CODE_SANDBOX_ENABLED=true

# Docker image for code execution (build with: make sandbox-image)
CODE_SANDBOX_IMAGE=ai-chatbot-sandbox:local

# Execution timeout in seconds (default: 30)
CODE_SANDBOX_TIMEOUT=30

# Memory limit for sandbox (default: 512m)
CODE_SANDBOX_MEMORY_LIMIT=512m

# CPU limit for sandbox (default: 1.0 = 1 CPU core)
CODE_SANDBOX_CPU_LIMIT=1.0

# Pre-installed Python libraries (comma-separated)
# Default: numpy,pandas,matplotlib,scipy,sympy,pillow,reportlab,requests,beautifulsoup4,lxml,openpyxl,python-dateutil,pytz,fpdf2
CODE_SANDBOX_LIBRARIES=numpy,pandas,matplotlib,scipy,sympy,pillow,reportlab,requests,beautifulsoup4,lxml,openpyxl,python-dateutil,pytz,fpdf2

# =============================================================================
# Autonomous Agents
# =============================================================================
# Timeout for considering an agent execution "stuck" (default: 10 minutes)
AGENT_EXECUTION_TIMEOUT_MINUTES=10

# Time-to-live for approval requests in hours (default: 24 hours)
# Expired approvals are automatically ignored and cleaned up
AGENT_APPROVAL_TTL_HOURS=24

# Cooldown period between manual agent executions in seconds (default: 5 seconds)
# Prevents spamming the "Run" button
AGENT_EXECUTION_COOLDOWN_SECONDS=5

# Maximum messages before compaction is triggered (default: 50)
# Summarizes older messages to keep conversation within context limits
AGENT_COMPACTION_THRESHOLD=50

# Number of recent messages to keep uncompacted (default: 10)
AGENT_COMPACTION_KEEP_RECENT=10

# Maximum retries for transient failures like network errors or rate limits (default: 3)
AGENT_MAX_RETRIES=3

# Initial retry delay in seconds (default: 1.0, doubles with each retry)
AGENT_RETRY_BASE_DELAY_SECONDS=1.0

# Maximum retry delay cap in seconds (default: 30.0)
AGENT_RETRY_MAX_DELAY_SECONDS=30.0

# Default daily budget limit per agent in USD (0 = unlimited, default: 0)
AGENT_DEFAULT_DAILY_BUDGET_USD=0

# =============================================================================
# WhatsApp Integration (for Autonomous Agents)
# =============================================================================
# Enables autonomous agents to send WhatsApp notifications to users.
# See README.md for detailed setup instructions.
#
# IMPORTANT CONCEPTS:
# - Phone Number ID: A numeric ID (e.g., 982966681562240), NOT the phone number itself
# - Registration: Your business phone must be registered via the API before sending
# - Template messages: Required for first contact (business-initiated conversations)
# - 24-hour window: Free-form text only works within 24h after user messages you first
#
# User recipient phone numbers are configured per-user in app settings, not here.

# Phone Number ID from WhatsApp API Setup page
# IMPORTANT: This is a numeric ID like "982966681562240", NOT a phone number!
# Find it at: Meta for Developers → Your App → WhatsApp → API Setup → "Phone number ID"
WHATSAPP_PHONE_NUMBER_ID=

# Permanent access token from System User (not the temporary 24h token)
# Generate at: Business Settings → System Users → Generate Token
# Required permissions: whatsapp_business_messaging, whatsapp_business_management
WHATSAPP_ACCESS_TOKEN=

# Message template name for business-initiated conversations (required for first contact)
# Create templates at: Meta Business Suite → WhatsApp Manager → Message Templates
# The template must be approved by Meta before use
# Template body must have TWO variables: "{{1}}: {{2}}"
#   {{1}} = Agent name (e.g., "Daily Briefing Agent")
#   {{2}} = Message content
WHATSAPP_TEMPLATE_NAME=

# Timeout for WhatsApp API requests in seconds (default: 10)
WHATSAPP_API_TIMEOUT=10

# Maximum message length before truncation
# WhatsApp template body variables are limited to 1024 characters each
WHATSAPP_MAX_MESSAGE_LENGTH=1024

# =============================================================================
# Context Caching (Gemini)
# =============================================================================
# Cache the static system prompt + tool definitions using Gemini's Context Caching API
# Reduces input token costs by ~75% on cached tokens
# Enabled by default — set to false to disable if you encounter issues
CONTEXT_CACHE_ENABLED=true

# Cache time-to-live in seconds (default: 3600 = 1 hour)
# Minimum is 60 seconds. Longer TTL = fewer cache creations but slower prompt updates
CONTEXT_CACHE_TTL_SECONDS=3600

# Seconds before expiry to proactively renew the cache (default: 300 = 5 minutes)
CONTEXT_CACHE_RENEWAL_BUFFER_SECONDS=300

# =============================================================================
# History Enrichment
# =============================================================================
# Gap threshold for "session resumed" markers in hours (default: 4)
# When messages are more than this many hours apart, a session gap indicator is shown
HISTORY_SESSION_GAP_HOURS=4
